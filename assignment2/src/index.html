<!DOCTYPE html>

<!--
  COLLABORATORS:
  
-->
<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Checkerboard</title>

<!-- Load style sheets -->
<link rel="stylesheet" type="text/css" href="mainLayout.css" />

<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="checker.js"></script>
<script type="text/javascript" src="boardEvent.js"></script>
<script type="text/javascript" src="board.js"></script>
<script type="text/javascript" src="rules.js"></script>

<script type="text/javascript">

//This script extracts parameters from the URL
//from jquery-howto.blogspot.com

    $.extend({
        getUrlVars : function() {
            var vars = [], hash;
            var hashes = window.location.href.slice(
                    window.location.href.indexOf('?') + 1).split('&');
            for ( var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar : function(name) {
            return $.getUrlVars()[name];
        }
    });

    var DEFAULT_BOARD_SIZE = 8;

    //data model
    var board;
    var rules;
    var whoseTurn = "black";

    var directionOf = function(color) {
      if (color == "black") {
        return -1;
      }
      return 1;
    }

    // Fill in this function to toggle the display for whose turn
    // The color parameter should be either "black" or "red"
    var toggleTurn = function(color) {
        if (color == "black") {
            whoseTurn = "red";
        } else {
            whoseTurn = "black";
        }
        setTurnDiv(whoseTurn);
    }

    function setTurnDiv(colour) {
        var turn = document.getElementById("turnColour");
        var turnDiv = document.getElementById("turnDiv");

        if (colour == "blue") {
            turnDiv.style.backgroundColor = colour;
            turn.innerHTML = "End Game";
        } else {
            turn.innerHTML = whoseTurn.charAt(0).toUpperCase() + whoseTurn.slice(1) + " Turn";
            turnDiv.style.backgroundColor = whoseTurn;
        }
    }

    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    $(document).ready(function() {

        if ($.getUrlVar('size') && $.getUrlVar('size') >= 6) {
            board = new Board($.getUrlVar('size'));
        } else {
            board = new Board(DEFAULT_BOARD_SIZE);
        }


	   rules = new Rules(board);

        function drawCheckerboard() {
            var ctx = document.getElementById('canvas').getContext('2d');
            ctx.clearRect(0, 0, 400, 400);
            var each_checker_width = 400 / board.size();
            var flip = true;
            for (x = 0; x < board.size(); x++) {
                for (y = 0; y < board.size(); y++) {
                    // Draw checker squares
                    if (flip) {
                        ctx.fillStyle = "white";
                    } else {
                        ctx.fillStyle = "grey";
                    }
                    ctx.fillRect(x * each_checker_width, 
                                y * each_checker_width, 
                                each_checker_width, 
                                each_checker_width);
                    flip = !flip;
                }
                flip = !flip;
            }
        }

        var tickId;

        function setTimer(seconds, milliseconds) {
            var timer = document.getElementById("timer");
            if (milliseconds < 10) {
                milliseconds = "0" + milliseconds;
            }
            if (seconds < 10) {
                seconds = "0" + seconds;
            }
            timer.innerHTML = "00:" + seconds + ":" + milliseconds;
        }

        function setTimerFontColour(font_colour) {
            timer.style.color = font_colour;
        }

        function countdown() {
            var seconds = 10;
            var milliseconds = 0;
            function tick() {
                // console.log(seconds, milliseconds);
                setTimer(seconds, milliseconds);
                if (milliseconds == 0 && seconds > 0) {
                    seconds -= 1;
                    milliseconds = 100;
                    tickId = setTimeout(tick, 10);

                } else if (milliseconds == 0 && seconds == 0) {
                    $( "#btnAutoMove" ).trigger( "click" );

                } else {
                    milliseconds -= 1;
                    tickId = setTimeout(tick, 10);
                }
            }
            tickId = setTimeout(tick, 100);
        }

        var checkerId = 0;
        var width = 400 / board.size();
        var sources = {
            black_piece : "graphics/black-piece.png",
            black_king : "graphics/black-king.png",
            red_piece : "graphics/red-piece.png",
            red_king : "graphics/red-king.png"
        };

        board.addEventListener('add',function (e) {
            e.details.checker.id = "checker" + checkerId;
            checkerId++;

            var img = new Image();
            img.id = e.details.checker.id;
            img.style.position = "absolute";
            img.style.zIndex = 3;
            img.style.height = width + "px";
            img.style.top = e.details.checker.row * width + "px";
            img.style.left = e.details.checker.col * width + "px";

            if (e.details.checker.color == "red") {
                if (e.details.checker.isKing) {
                    img.src = sources.red_king;
                } else {
                    img.src = sources.red_piece;
                }
            } else {
                if (e.details.checker.isKing) {
                    img.src = sources.black_king;
                } else {
                    img.src = sources.black_piece;
                }
            }

            var canvasDiv = document.getElementById("canvasDiv");
            canvasDiv.style.position = "relative";
            canvasDiv.appendChild(img);

            var svg = document.getElementById("svgCanvas");
            svg.style.position = "absolute";
            svg.style.zIndex = 4;
            svg.style.top = "0px";
    	},true);

    	board.addEventListener('move',function (e) {
            // Move checker
            var checker = e.details.checker;
            var img = document.getElementById(checker.id);
            img.style.top = e.details.toRow * width + "px";
            img.style.left = e.details.toCol * width + "px";

            // Move arrow
            var arrowLine = document.getElementById("arrowLine");
            arrowLine.setAttribute("y1", e.details.fromRow * width + width/2 + "px");
            arrowLine.setAttribute("x1", e.details.fromCol * width + width/2 + "px");
            arrowLine.setAttribute("y2", e.details.toRow * width + width/2 + "px");
            arrowLine.setAttribute("x2", e.details.toCol * width + width/2 + "px");

            // Restart Timer
            clearTimeout(tickId);
            countdown();
    	},true);

        board.addEventListener('remove', function(e) {
            var checkerId = e.details.checker.id;
            document.getElementById(checkerId).remove();
        }, true);

        board.addEventListener('promote',function (e) {
            var checker = e.details.checker;
            var img = document.getElementById(checker.id);
            if (checker.isKing && checker.color == "red") {
                img.src = sources.red_king;    
            } else {
                img.src = sources.black_king;
            }
    	},true);

        $("#btnStartGame").click(function(evt) {
            // Restart Timer
            clearTimeout(tickId);
            countdown();
        });

        $("#btnNewGame").click(function(evt) {
            board.prepareNewGame();

            // Set turn to black
            whoseTurn = "black";
            setTurnDiv(whoseTurn);

            // Remove arrow
            var arrowLine = document.getElementById("arrowLine");
            arrowLine.setAttribute("y1", "0px");
            arrowLine.setAttribute("x1", "0px");
            arrowLine.setAttribute("y2", "0px");
            arrowLine.setAttribute("x2", "0px");

            // Stop countdown
            clearTimeout(tickId);
            setTimer(10, 0);
            setTimerFontColour(whoseTurn);
        });

        $("#btnAutoMove").click(function(evt) {
            // Restart countdown
            clearTimeout(tickId);
            countdown();
            
            // Move checkers
            var playerColor = whoseTurn;
            var playerDirection = directionOf(playerColor);
            var result = rules.makeRandomMovement(playerColor, playerDirection);
            if (result != null) {
                toggleTurn(whoseTurn);
                setTimerFontColour(whoseTurn);

            } else {
                // Stop timer
                clearTimeout(tickId);
                
                // set timer font to blue
                setTimerFontColour("blue");

                // set turn div to blue
                setTurnDiv("blue");
            }
        });

        board.prepareNewGame();
        drawCheckerboard();

    });
</script>


</head>

<body>

<table id="mainTable">
    <tr>
        <td id="navigation">
            <table>
                <tr>
                    <td><div id="timer" style="text-align: center; font-size: -webkit-xxx-large; width: 180px">00:00:00</div></td>
                </tr>
			  <tr><td>		<!-- Your code here -->			
                <div id="turnDiv" style="text-align: center; background: black; color: white;"><span id="turnColour">Black Turn</span></div>
              </td></tr>
              <tr><td><input id="btnStartGame" type="button" name="new" value="Start Game"></td></tr>
              <tr><td><input id="btnNewGame" type="button" name="new" value="New Game"/></td></tr>
              <tr><td><input id="btnAutoMove" type="button" name="new" value="Auto Move"/></td></tr>
              <tr><td><input id="btnUndo" type="button" name="new" value="Undo"></td></tr>
              <tr><td><input id="btnRedo" type="button" name="new" value="Redo"></td></tr>
            </table>
        </td>

        <td id="content">
			<div id="canvasDiv">
                <canvas id="canvas" width="400" height="400"></canvas>
                <!-- Sets the svg 'canvas' width and height -->
                <svg id="svgCanvas" width="400px" height="400px">
                  <defs>
                  <!-- markerWidth and markerHeight sets the 
                  arrow head width and height -->
                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L0,6 L9,3 z" fill="#ff0" />
                    </marker>
                  </defs>
                <!-- x1 y1 sets the starting position
                    x2 y2 sets the ending position -->
                  <line id="arrowLine" x1="0" y1="0" x2="0" y2="0" stroke="#ff0" stroke-width="3" marker-end="url(#arrow)" />
                </svg>

            </div>
        </td>
    </tr>

   </table>

</body>

</html>
