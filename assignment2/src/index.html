<!DOCTYPE html>

<!--
  COLLABORATORS:
  
-->
<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Checkerboard</title>

<!-- Load style sheets -->
<link rel="stylesheet" type="text/css" href="mainLayout.css" />

<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="checker.js"></script>
<script type="text/javascript" src="boardEvent.js"></script>
<script type="text/javascript" src="board.js"></script>
<script type="text/javascript" src="rules.js"></script>

<script type="text/javascript">

//This script extracts parameters from the URL
//from jquery-howto.blogspot.com

    $.extend({
        getUrlVars : function() {
            var vars = [], hash;
            var hashes = window.location.href.slice(
                    window.location.href.indexOf('?') + 1).split('&');
            for ( var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar : function(name) {
            return $.getUrlVars()[name];
        }
    });

    var DEFAULT_BOARD_SIZE = 8;

    //data model
    var board;
    var rules;
    var whoseTurn = "black";

    var directionOf = function(color) {
      if (color == "black") {
        return -1;
      }
      return 1;
    }

    // Fill in this function to toggle the display for whose turn
    // The color parameter should be either "black" or "red"
    var toggleTurn = function(color) {
        if (color == "black") {
            whoseTurn = "red";
        } else {
            whoseTurn = "black";
        }
        var turn = document.getElementById("turnColour");
        var turnDiv = document.getElementById("turnDiv");
        turn.innerHTML = whoseTurn.charAt(0).toUpperCase() + whoseTurn.slice(1);
        turnDiv.style.backgroundColor = whoseTurn;
    }

    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    $(document).ready(function() {

        if ($.getUrlVar('size') && $.getUrlVar('size') >= 6) {
            board = new Board($.getUrlVar('size'));
        } else {
            board = new Board(DEFAULT_BOARD_SIZE);
        }


	   rules = new Rules(board);


     	// Your code here
        // red at: for size 8
        // (1,0) (3,0) (5,0) (7,0) (red king)
        // (0,1) (2,1) (4,1) (6,1)
        // black at:
        // (1,6) (3,6) (5,6) (7,6)
        // (0,7) (2,7) (4,7) (6,7) (black king)
        function draw(move) {
            drawCheckerboard();
            // drawCheckers();
            // if (typeof move !== "undefined")
            //     drawArrow(move);
        }

        function drawCheckerboard() {
            var ctx = document.getElementById('canvas').getContext('2d');
            ctx.clearRect(0, 0, 400, 400);
            var each_checker_width = 400 / board.size();
            var flip = true;
            for (x = 0; x < board.size(); x++) {
                for (y = 0; y < board.size(); y++) {
                    // Draw checker squares
                    if (flip) {
                        ctx.fillStyle = "white";
                    } else {
                        ctx.fillStyle = "grey";
                    }
                    ctx.fillRect(x * each_checker_width, 
                                y * each_checker_width, 
                                each_checker_width, 
                                each_checker_width);
                    flip = !flip;
                }
                flip = !flip;
            }
        }

        // function loadImages(sources, callback) {
        //     var images = {};
        //     var loadedImages = 0;
        //     var numImages = 0;
        //     // get num of sources
        //     for(var src in sources) {
        //         numImages++;
        //     }
        //     for(var src in sources) {
        //         images[src] = new Image();
        //         images[src].onload = function() {
        //             if(++loadedImages >= numImages) {
        //                 callback(images);
        //             }
        //         };
        //         images[src].src = sources[src];
        //     }
        // }

        // function drawCheckers() {
            // var ctx = document.getElementById('canvas').getContext('2d');
            // var arr = board.getAllCheckers();
            // var width = 400 / board.size();
            // var index_position = [10, 155]; // pixels at (0, 0)
            // var sources = {
            //     black_piece : "graphics/black-piece.png",
            //     black_king : "graphics/black-king.png",
            //     red_piece : "graphics/red-piece.png",
            //     red_king : "graphics/red-king.png"
            // };

            // var img = new Image();
            // img.src = "graphics/red-piece.png";
            // img.id = "drag";
            // img.style.position = "absolute";
            // img.style.zIndex = 2;

            // // document.body.appendChild(img);
            // document.getElementById('content').appendChild(img); 
            
            // for (var i = 0; i < arr.length; i++) {
            //     var checker = arr[i];
            //     checker.id = "drag" + i; // add DOM id to checker
            //     var img = new Image();
            //     img.id = checker.id;
            //     img.style.position = "absolute";
            //     img.style.zIndex = 2;

            //     // Set image src
            //     if (checker.color == "red") {
            //         if (checker.isKing) {
            //             img.src = sources.red_piece;
            //         } else {
            //             img.src = sources.red_king;
            //         }
            //     } else {
            //         if (checker.isKing) {
            //             img.src = sources.black_piece;
            //         } else {
            //             img.src = sources.black_king;
            //         }
            //     }
            // }
            // load image when loaded
            // loadImages(sources, function(images) {
            //     for (var i = 0; i < arr.length; i++) {
            //         var checker = arr[i];
            //         var img;
            //         if (checker.color == "red") {
            //             if (checker.isKing) {
            //                 img = images.red_king;
            //             } else {
            //                 img = images.red_piece;
            //             }
            //         } else {
            //             if (checker.isKing) {
            //                 img = images.black_king;
            //             } else {
            //                 img = images.black_piece;
            //             }
            //         }
            //         ctx.drawImage(img, 
            //                     checker.col * each_checker_width, 
            //                     checker.row * each_checker_width, 
            //                     each_checker_width, 
            //                     each_checker_width);
            //     }
            // });
        // }

        function drawArrow(move) {
            var ctx = document.getElementById('canvas').getContext('2d');
            console.log(move);
            ctx.save();
            var scale = DEFAULT_BOARD_SIZE / board.size();
            var width = 400/board.size();
            var from_center = [width * move.from_col + width/2, 
                                width * move.from_row + width/2];
            var to_center = [width * move.to_col + width/2,
                            width * move.to_row + width/2];
            console.log(from_center, to_center);
            ctx.fillStyle = "yellow";
            // console.log(scale);
            //ctx.scale(scale, scale);

            // translate first than scale
            ctx.beginPath();
            
            // ctx.translate(100, 0); // translate to rectangle center 
                          // x = x + 0.5 * width
                          // y = y + 0.5 * height
            
            // ctx.translate(-100, 0); // translate back
            
            ctx.moveTo(75, 50);
            // ctx.rotate((Math.PI / 180) * 45); // rotate
            ctx.lineTo(100, 75);
            ctx.lineTo(100, 25);
            ctx.fill();
            // ctx.save()

            ctx.strokeStyle = "yellow";
            ctx.beginPath();
            ctx.moveTo(from_center[0], from_center[1]);
            ctx.lineTo(to_center[0], to_center[1]);
            ctx.stroke();
            ctx.restore();
        }       

        var checkerId = 0;
        var width = 400 / board.size();
        var sources = {
            black_piece : "graphics/black-piece.png",
            black_king : "graphics/black-king.png",
            red_piece : "graphics/red-piece.png",
            red_king : "graphics/red-king.png"
        };

        board.addEventListener('add',function (e) {
            e.details.checker.id = "checker" + checkerId;
            checkerId++;

            var img = new Image();
            img.id = e.details.checker.id;
            img.style.position = "absolute";
            img.style.zIndex = 3;
            img.style.height = width + "px";
            img.style.top = e.details.checker.row * width + "px";
            img.style.left = e.details.checker.col * width + "px";

            if (e.details.checker.color == "red") {
                if (e.details.checker.isKing) {
                    img.src = sources.red_king;
                } else {
                    img.src = sources.red_piece;
                }
            } else {
                if (e.details.checker.isKing) {
                    img.src = sources.black_king;
                } else {
                    img.src = sources.black_piece;
                }
            }

            var canvasDiv = document.getElementById("canvasDiv");
            canvasDiv.style.position = "relative";
            canvasDiv.appendChild(img);

            var svg = document.getElementById("svgCanvas");
            svg.style.position = "absolute";
            svg.style.zIndex = 4;
            svg.style.top = "0px";


    	},true);

    	board.addEventListener('move',function (e) {
            var checker = e.details.checker;
            var img = document.getElementById(checker.id);
            img.style.top = e.details.toRow * width + "px";
            img.style.left = e.details.toCol * width + "px";
            console.log(e);
            var arrowLine = document.getElementById("arrowLine");
            arrowLine.setAttribute("y1", e.details.fromRow * width + width/2 + "px");
            arrowLine.setAttribute("x1", e.details.fromCol * width + width/2 + "px");
            arrowLine.setAttribute("y2", e.details.toRow * width + width/2 + "px");
            arrowLine.setAttribute("x2", e.details.toCol * width + width/2 + "px");

            console.log(arrowLine);
    	},true);

        board.addEventListener('remove', function(e) {
            var checkerId = e.details.checker.id;
            document.getElementById(checkerId).remove();
        }, true);

        board.addEventListener('promote',function (e) {
            var checker = e.details.checker;
            var img = document.getElementById(checker.id);
            if (checker.isKing && checker.color == "red") {
                img.src = sources.red_king;    
            } else {
                img.src = sources.black_king;
            }
    	},true);

        
        $("#btnNewGame").click(function(evt) {
            board.prepareNewGame();
            drawCheckerboard();
            
            whoseTurn = "black";
            var turn = document.getElementById("turnColour");
            var turnDiv = document.getElementById("turnDiv");
            turn.innerHTML = whoseTurn.charAt(0).toUpperCase() + whoseTurn.slice(1);
            turnDiv.style.backgroundColor = whoseTurn;
        });

        $("#btnAutoMove").click(function(evt) {
          var playerColor = whoseTurn;
          var playerDirection = directionOf(playerColor);
          var result = rules.makeRandomMovement(playerColor, playerDirection);
          if (result != null) {
            toggleTurn(whoseTurn);
          }
        });

        board.prepareNewGame();
        drawCheckerboard();

    });
</script>


</head>

<body>

<table id="mainTable">
    <tr>
        <td id="navigation">
          <table>
			  <tr><td>		<!-- Your code here -->			
                <div id="turnDiv" style="text-align: center; background: black; color: white;"><span id="turnColour">Black</span> Turn</div>
              </td></tr>
              <tr><td><input id="btnNewGame" type="button" name="new" value="New Game"/></td></tr>
              <tr><td><input id="btnAutoMove" type="button" name="new" value="Auto Move"/></td></tr>

            </table>
        </td>

        <td id="content">
			<div id="canvasDiv">
                <canvas id="canvas" width="400" height="400"></canvas>
                <!-- Sets the svg 'canvas' width and height -->
                <svg id="svgCanvas" width="400px" height="400px">
                  <defs>
                  <!-- markerWidth and markerHeight sets the 
                  arrow head width and height -->
                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                      <path d="M0,0 L0,6 L9,3 z" fill="#ff0" />
                    </marker>
                  </defs>
                <!-- x1 y1 sets the starting position
                    x2 y2 sets the ending position -->
                  <line id="arrowLine" x1="0" y1="0" x2="0" y2="0" stroke="#ff0" stroke-width="3" marker-end="url(#arrow)" />
                </svg>

            </div>
        </td>
    </tr>

   </table>

</body>

</html>
