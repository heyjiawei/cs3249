<!DOCTYPE html>

<!--
  COLLABORATORS:
  
-->
<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<title>Checkerboard</title>

<!-- Load style sheets -->
<link rel="stylesheet" type="text/css" href="mainLayout.css" />

<!-- Load any supplemental Javascript libraries here -->
<script type="text/javascript" src="external_js/jquery-1.9.0.min.js"></script>
<script type="text/javascript" src="checker.js"></script>
<script type="text/javascript" src="boardEvent.js"></script>
<script type="text/javascript" src="board.js"></script>
<script type="text/javascript" src="rules.js"></script>

<script type="text/javascript">

//This script extracts parameters from the URL
//from jquery-howto.blogspot.com

    $.extend({
        getUrlVars : function() {
            var vars = [], hash;
            var hashes = window.location.href.slice(
                    window.location.href.indexOf('?') + 1).split('&');
            for ( var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        },
        getUrlVar : function(name) {
            return $.getUrlVars()[name];
        }
    });

    var DEFAULT_BOARD_SIZE = 8;

    //data model
    var board;
    var rules;
    var whoseTurn = "black";

    var directionOf = function(color) {
      if (color == "black") {
        return -1;
      }
      return 1;
    }

    // Fill in this function to toggle the display for whose turn
    // The color parameter should be either "black" or "red"
    var toggleTurn = function(color) {
	// Your code here
        if (color == "black") {
            whoseTurn = "red";
        } else {
            whoseTurn = "black";
        }
    }

    // var clear = function() {
    //     var ctx = document.getElementById('canvas').getContext('2d');
    //     ctx.clearRect(0, 0, 400, 400);
    // }

    // var draw = function() {
    //     // draw checkerboard again
    //     var each_checker_width = 400 / board.size();
    //     var ctx = document.getElementById('canvas').getContext('2d');
    //     var flip = true;
    //     for (x = 0; x < board.size(); x++) {
    //         for (y = 0; y < board.size(); y++) {
    //             // Draw checker squares
    //             if (flip) {
    //                 ctx.fillStyle = "white";
    //             } else {
    //                 ctx.fillStyle = "grey";
    //             }
    //             ctx.fillRect(x * each_checker_width, 
    //                         y * each_checker_width, 
    //                         each_checker_width, 
    //                         each_checker_width);
    //             flip = !flip;
    //         }
    //         flip = !flip;
    //     }

    //     var arr = board.getAllCheckers();
    //     for (var i = 0; i < arr.length; i++) {
    //         var checkerObj = arr[i];
    //         var checker = new Image();
    //         if (checkerObj.isKing) {
    //             checker.src = "graphics/"+ checkerObj.color +"-king.png";
    //         } else {
    //             checker.src = "graphics/"+ checkerObj.color +"-piece.png";
    //         }
    //         console.log(checker);
    //         ctx.drawImage(checker, 
    //             checker.col * each_checker_width,
    //             checker.row * each_checker_width,
    //             each_checker_width,
    //             each_checker_width);
    //         console.log('hi');
    //     }
    // }

    // This allows the Javascript code inside this block to only run when the page
    // has finished loading in the browser.
    $(document).ready(function() {

        if ($.getUrlVar('size') && $.getUrlVar('size') >= 6) {
            board = new Board($.getUrlVar('size'));
        } else {
            board = new Board(DEFAULT_BOARD_SIZE);
        }


	   rules = new Rules(board);


     	// Your code here
        // red at: for size 8
        // (1,0) (3,0) (5,0) (7,0) (red king)
        // (0,1) (2,1) (4,1) (6,1)
        // black at:
        // (1,6) (3,6) (5,6) (7,6)
        // (0,7) (2,7) (4,7) (6,7) (black king)
        function draw() {
            drawCheckerboard();
            drawCheckers();
        }

        function drawCheckerboard() {
            var ctx = document.getElementById('canvas').getContext('2d');
            ctx.clearRect(0, 0, 400, 400);
            var each_checker_width = 400 / board.size();
            var flip = true;
            for (x = 0; x < board.size(); x++) {
                for (y = 0; y < board.size(); y++) {
                    // Draw checker squares
                    if (flip) {
                        ctx.fillStyle = "white";
                    } else {
                        ctx.fillStyle = "grey";
                    }
                    ctx.fillRect(x * each_checker_width, 
                                y * each_checker_width, 
                                each_checker_width, 
                                each_checker_width);
                    flip = !flip;
                }
                flip = !flip;
            }
        }

        function loadImages(sources, callback) {
            var images = {};
            var loadedImages = 0;
            var numImages = 0;
            // get num of sources
            for(var src in sources) {
                numImages++;
            }
            for(var src in sources) {
                images[src] = new Image();
                images[src].onload = function() {
                    if(++loadedImages >= numImages) {
                        callback(images);
                    }
                };
                images[src].src = sources[src];
            }
        }

        function drawCheckers() {
            var ctx = document.getElementById('canvas').getContext('2d');
            var arr = board.getAllCheckers();
            var each_checker_width = 400 / board.size();
            var sources = {
                black_piece : "graphics/black-piece.png",
                black_king : "graphics/black-king.png",
                red_piece : "graphics/red-piece.png",
                red_king : "graphics/red-king.png"
            };
            // load image when loaded
            loadImages(sources, function(images) {
                for (var i = 0; i < arr.length; i++) {
                    var checker = arr[i];
                    var img;
                    if (checker.color == "red") {
                        if (checker.isKing) {
                            img = images.red_king;
                        } else {
                            img = images.red_piece;
                        }
                    } else {
                        if (checker.isKing) {
                            img = images.black_king;
                        } else {
                            img = images.black_piece;
                        }
                    }
                    ctx.drawImage(img, 
                                checker.col * each_checker_width, 
                                checker.row * each_checker_width, 
                                each_checker_width, 
                                each_checker_width);
                }
            });
        }

        // var each_checker_width = 400 / board.size();

        // var createChecker = function(x, y, width, colour, isKing) {
        //     var checker = new Image();
        //     if (isKing) {
        //         checker.src = "graphics/"+ colour +"-king.png";
        //     } else {
        //         checker.src = "graphics/"+ colour +"-piece.png";
        //     }
        //     board.add(new Checker(colour, isKing), y, x);
        //     checker.onload = function() {
        //         ctx.drawImage(checker, x * width, y * width, width, width);
        //     }
        // }

        // var canvas = document.getElementById('canvas');
        // if (canvas.getContext) {
        //     var ctx = canvas.getContext('2d');
        //     var flip = true;
        //     for (x = 0; x < board.size(); x++) {
        //         for (y = 0; y < board.size(); y++) {
        //             // Draw checker squares
        //             if (flip) {
        //                 ctx.fillStyle = "white";
        //             } else {
        //                 ctx.fillStyle = "grey";
        //             }
        //             ctx.fillRect(x * each_checker_width, 
        //                         y * each_checker_width, 
        //                         each_checker_width, 
        //                         each_checker_width);
        //             flip = !flip;

        //             // Place checker images
        //             if (y == 0 && (x % 2 == 1)) {
        //                 createChecker(x, y, each_checker_width, "red", false);
        //             }
        //             if (y == 1 && (x % 2 == 0)) {
        //                 createChecker(x, y, each_checker_width, "red", false);
        //             }
        //             if ((y == board.size() - 2) && (x % 2 == 1)) {
        //                 createChecker(x, y, each_checker_width, "black", false);
        //             }
        //             if ((y == board.size() - 1) && (x % 2 == 0)) {
        //                 createChecker(x, y, each_checker_width, "black", false);
        //             }
        //         }
        //         flip = !flip;
        //     }
        // }

        board.addEventListener('add',function (e) {
    		// Your code here

    	},true);

    	board.addEventListener('move',function (e) {
    		// Your code here
    	},true);

        board.addEventListener('remove', function(e) {
        	// Your code here
        }, true);

        board.addEventListener('promote',function (e) {
    		// Your code here
    	},true);

        
        $("#btnNewGame").click(function(evt) {
            board.prepareNewGame();
            draw();
        });

        $("#btnAutoMove").click(function(evt) {
          var playerColor = whoseTurn;
          var playerDirection = directionOf(playerColor);
          var result = rules.makeRandomMovement(playerColor, playerDirection);
          
          if (result != null) {
            draw();
            toggleTurn(whoseTurn);
          }
        });

        board.prepareNewGame();
        draw();

    });
</script>


</head>

<body>

<table id="mainTable">
    <tr>
        <td id="navigation">
          <table>
			  <tr><td>		<!-- Your code here -->			
                <div id="turnDiv" style="text-align: center;"><span id="turnColour">Your</span> Turn</div>
              </td></tr>
              <tr><td><input id="btnNewGame" type="button" name="new" value="New Game"/></td></tr>
              <tr><td><input id="btnAutoMove" type="button" name="new" value="Auto Move"/></td></tr>

            </table>
        </td>

        <td id="content">
			<canvas id="canvas" width="400" height="400"></canvas>
        </td>
    </tr>

   </table>

</body>

</html>
